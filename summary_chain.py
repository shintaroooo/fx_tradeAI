from langchain.chat_models import ChatOpenAI
from langchain.prompts import FewShotPromptTemplate, PromptTemplate
from langchain.chains import LLMChain

def load_summary_chain(api_key: str):
    examples = [
        {
            "strategy": """
1. 現在のトレンド分析
日経平均株価は現在36452.30であり、SMAs（5日移動平均35816.51と20日移動平均34968.18）から見ても短期的に上昇トレンドにあることがわかります。しかし、RSIは79.7と非常に高く、過熱感が強い状態です。MACDもマイナスであり、トレンドの弱さを示唆しています。ボリンジャーバンドの上限に近づいており、価格が上昇し続けるには限界があるかもしれません。ストキャスティクスも非常に高い値（%K: 97.8, %D: 97.6）を示しており、短期的な調整が予想されます。

2. 勝率の高いエントリータイミング
ロングエントリー: もし価格が36400円付近でサポートを受けて反発する場合、ロングエントリーを考慮することができます。特に、RSIが70を下回るタイミングでのエントリーが理想的です。
ショートエントリー: 価格がボリンジャーバンドの上限に接触したり、RSIが80を超えた場合、ショートエントリーを検討することが推奨されます。また、ストキャスティクスが過剰買いの状態から転換するタイミングもショートエントリーの好機です。
3. 利確と損切り目安
ロングポジション:利確目安: 36700円〜37000円 損切り目安: 36000円（サポートラインを下回った場合）
ショートポジション:利確目安: 35500円〜35200円 損切り目安: 36600円（レジスタンスラインを上回った場合）
4. 注意点とアドバイス 現在の市場は過熱感が強く、短期的な調整が入る可能性が高いです。特に、経済指標や地政学的リスクに注意を払い、それに応じて戦略を修正することが重要です。
トレードは感情に流されず、テクニカル指標に基づいた冷静な判断を心がけましょう。
リスク管理を徹底し、ポジションサイズを適切に設定することが成功の鍵です。特に、急激な市場変動に備えたストップロスを設定することをお勧めします。
"""
,
            "summary": """📊日経平均は上昇トレンドも過熱感あり。RSI・ストキャス高水準で短期調整に注意⚠️ロングは36400反発狙い、ショートはRSI80超・BB上限接触で。
                        👉予測AIで分析サポートhttps://fxtradeai.streamlit.app/
                        #FX #テクニカル分析 #LazyTech
                        """               
        },

        {
            "strategy": """
1. 現在のトレンド分析
現在のS&P500は、SMA5がSMA20を上回っているため、短期的には上昇トレンドにあります。しかし、MACDがマイナスであることから、上昇トレンドに対する弱気な兆候も見受けられます。RSIは55.6であり、過熱感はないものの、上昇の勢いが弱まっている可能性があります。ボリンジャーバンドの範囲内で価格が推移しており、上限に近づいていることから、反発のリスクも考慮する必要があります。ストキャスティクスは非常に高い値を示しており、短期的な過熱感があることを示唆しています。

2. 勝率の高いエントリータイミング
ロングエントリー: 価格がSMA5の水準（5533.72）を維持し、RSIが60を超えた場合、ロングエントリーを検討します。また、MACDがプラスに転じる兆候があれば、エントリーの信号として有効です。
ショートエントリー: ストキャスティクスが過熱とみなされる97を超えているため、価格がボリンジャーバンドの上限（5725.22）に近づいた際にショートエントリーを検討します。特に、価格が反転し始める兆候が見られた場合は、エントリーのチャンスと捉えます。
3. 利確と損切り目安
ロングエントリーの場合:
利確目安: 5700付近（ボリンジャーバンドの上限に近い水準）
損切り目安: 5500（SMA20を下回った場合）
ショートエントリーの場合:
利確目安: 5400（SMA20の水準）
損切り目安: 5750（ボリンジャーバンドの上限を突破した場合）
4. 注意点とアドバイス
市場の変動性が高まる可能性があるため、ニュースや経済指標の発表には注意を払うことが重要です。特に、米国の経済指標や企業の決算発表は市場に大きな影響を与えることがあります。
トレードを行う際は、リスク管理を徹底し、ポジションサイズを適切に設定することが重要です。
テクニカル指標に基づく判断だけでなく、ファンダメンタルズや市場のセンチメントも考慮することで、より良いトレード戦略が構築できます。
            """
            ,
            "summary": """📈S&P500は短期上昇トレンドながら勢い鈍化。RSI55.6、MACDマイナスで慎重判断を。ロングはRSI60超、ショートはBB上限と反転で検討を。
👉AIが戦略を提案https://fxtradeai.streamlit.app/
#米国株 #トレード戦略 #LazyTech
"""

        }
    ]

    example_prompt = PromptTemplate(
        input_variables=["strategy"],
        template="戦略: {strategy}\n要約: "
    )

    prompt = FewShotPromptTemplate(
        examples=examples,
        example_prompt=example_prompt,
        suffix="戦略: {strategy}\n要約: ",
        input_variables=["strategy"]
    )

    llm = ChatOpenAI(model_name="gpt-4", temperature=0.2, openai_api_key=api_key)

    return LLMChain(llm=llm, prompt=prompt, output_key="summary")
